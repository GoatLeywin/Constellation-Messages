<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Private Image Feed</title>
  <style>
    body { font-family: sans-serif; background:#111; color:#eee; margin:0; }
    #login { max-width:400px; margin:100px auto; text-align:center; }
    #feed { max-width:800px; margin:20px auto; display:none; padding:0 16px; }
    input { padding:8px; margin:6px; border-radius:6px; border:none; }
    button { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; background:#444; color:#fff; }
    button:hover { background:#666; }
    img { max-width:100%; display:block; margin:20px auto; }

    /* Debug panel */
    #debug {
      position: fixed;
      bottom: 0;
      right: 0;
      max-width: 350px;
      max-height: 300px;
      overflow-y: auto;
      background: rgba(0,0,0,0.8);
      color: #0f0;
      font-family: monospace;
      font-size: 12px;
      padding: 8px;
      z-index: 9999;
      border-top-left-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="login">
    <h2>🔒 Sign In</h2>
    <input id="user" placeholder="User ID" />
    <input id="pass" type="password" placeholder="Password" />
    <button onclick="login()">Enter</button>
    <p id="msg"></p>
  </div>

  <div id="feed"></div>
  <div id="debug"></div>

<script>
const debugPanel = document.getElementById("debug");

function logDebug(msg){
  const p = document.createElement("div");
  p.textContent = msg;
  debugPanel.appendChild(p);
  debugPanel.scrollTop = debugPanel.scrollHeight;
}

// --- USERS (hardcoded usernames + passwords) ---
const USERS = {
  "alice": "pass123",
  "bob": "secret456",
  "owner": "mypassword"
};

let currentUser = null;
let lastData = "";

// --- Login ---
function login(){
  const u = document.getElementById("user").value.trim();
  const p = document.getElementById("pass").value;
  logDebug(`Login attempt: user="${u}" pass="${p}"`);
  if(USERS[u] && USERS[u] === p){
    currentUser = u;
    document.getElementById("login").style.display = "none";
    document.getElementById("feed").style.display = "block";
    logDebug(`Login successful: currentUser="${currentUser}"`);
    startAutoRefresh();
  } else {
    document.getElementById("msg").innerText = "❌ Invalid login";
    logDebug(`Login failed for user="${u}"`);
  }
}

// --- Auto-refresh feed ---
function startAutoRefresh(){
  logDebug("Starting feed auto-refresh...");
  loadFeed();
  setInterval(loadFeed, 15000);
}

// --- Fetch posts from Google Sheets ---
async function loadFeed(){
  const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT4Grw3tRlqGbesjOvBSJ74P-dWTId_l34k4tXiuXEmJQUo-qi-f67C3tllucwzOzFLaPaP9CPe4i8D/gviz/tq?tqx=out:json";
  logDebug("Fetching feed from Google Sheets...");

  try {
    const res = await fetch(url);
    const text = await res.text();

    // Robustly extract JSON from gviz wrapper
    const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\)/);
    if(!match){
      throw new Error("Could not parse Google Sheets response");
    }
    const json = JSON.parse(match[1]);

    // Convert rows to objects
    const posts = json.table.rows.map((r, i) => ({
      to: r.c[0]?.v,
      image: r.c[1]?.v,
      time: r.c[2]?.v
    }));

    logDebug(`Fetched ${posts.length} posts from sheet:`);
    posts.forEach((p, i) => logDebug(`  [${i}] to="${p.to}" image="${p.image}" time="${p.time}"`));

    // Sort newest first
    posts.sort((a, b) => new Date(b.time) - new Date(a.time));

    const dataStr = JSON.stringify(posts);
    if(dataStr !== lastData){
      lastData = dataStr;
      renderFeed(posts);
    } else {
      logDebug("Feed unchanged, skipping render");
    }
  } catch(e){
    logDebug(`Error loading feed: ${e}`);
    console.error("Error loading feed:", e);
  }
}

// --- Render feed ---
function renderFeed(posts){
  const feed = document.getElementById("feed");
  feed.innerHTML = "";
  let count = 0;
  posts.forEach((p, i) => {
    logDebug(`Processing post [${i}]: to="${p.to}" image="${p.image}"`);
    if(p.to === "all" || p.to === currentUser){
      if(p.image){
        const img = document.createElement("img");
        img.src = "images/" + p.image;
        feed.appendChild(img);
        count++;
      }
    }
  });
  logDebug(`Rendered ${count} images for user "${currentUser}"`);
}
</script>
</body>
</html>

