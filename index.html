<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Star Stream</title>
  <link rel="icon" type="image/png" href="images/icon.png">
  <style>
    body { font-family: sans-serif; background:#111; color:#eee; margin:0; }
    #login { max-width:400px; margin:100px auto; text-align:center; }
    #feed { max-width:800px; margin:20px auto; display:none; padding:0 16px; position:relative; }
    input, select, textarea { padding:6px; margin:6px; border-radius:6px; border:none; }
    button { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; background:#444; color:#fff; }
    button:hover { background:#666; }
    img { max-width:100%; display:block; }
    .text-overlay {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      color: #fff;
      text-align: left;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: monospace;
      text-shadow: 2px 2px 4px #000;
      pointer-events: none;
      overflow-wrap: break-word;
      max-width: 70%;
      padding-right: 15%;
    }
    #refreshNotice, #submitNotice {
      position: fixed;
      top: 20px;
      right: 30px;
      font-family: monospace;
      font-size: 14px;
      color: #fff;
      text-shadow: 1px 1px 3px #000;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      pointer-events: none;
      z-index: 9999;
    }
    #debug {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background: #222;
      color: #0f0;
      font-family: monospace;
      font-size: 12px;
      padding: 10px;
      border-top: 1px solid #333;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <div id="login">
    <h2>🔒 Sign In</h2>
    <input id="user" placeholder="User ID" />
    <input id="pass" type="password" placeholder="Password" />
    <button onclick="login()">Enter</button>
    <p id="msg"></p>
  </div>

  <div id="feed"></div>
  <div id="refreshNotice">⟳ feed refreshed</div>
  <div id="submitNotice">✔ entry submitted</div>
  <div id="debug"></div>

<script>
// --- DEBUG ---
function logDebug(message) {
  const debug = document.getElementById("debug");
  const timestamp = new Date().toISOString().substr(11, 8);
  debug.innerText += `[${timestamp}] ${message}\n`;
  debug.scrollTop = debug.scrollHeight;
  console.log(message);
}

// --- USERS ---
const USERS = {
  "Scott": "madhatter",
  "Dexter": "funk",
  "Kade": "KRKR-110108",
  "Cole": "ILoveMarley"
};

let currentUser = null;
let lastData = "";

// --- Login ---
function login(){
  const u = document.getElementById("user").value.trim();
  const p = document.getElementById("pass").value;
  logDebug(`Attempt login: user="${u}"`);
  if(USERS[u] && USERS[u] === p){
    currentUser = u;
    logDebug(`✅ Login success: ${u}`);
    document.getElementById("login").style.display = "none";
    document.getElementById("feed").style.display = "block";
    startAutoRefresh();
  } else {
    logDebug("❌ Login failed");
    document.getElementById("msg").innerText = "❌ Invalid login";
  }
}

// --- Auto-refresh feed ---
function startAutoRefresh(){
  logDebug("🔁 Starting auto-refresh");
  loadFeed();
  setInterval(loadFeed, 15000);
}

// --- Fetch posts from Google Sheets (GVIZ JSON) ---
async function loadFeed(){
  const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT4Grw3tRlqGbesjOvBSJ74P-dWTId_l34k4tXiuXEmJQUo-qi-f67C3tllucwzOzFLaPaP9CPe4i8D/gviz/tq?tqx=out:json";

  console.log("[loadFeed] Fetching from:", url);

  try {
    const res = await fetch(url);
    const text = await res.text();

    console.log("[loadFeed] Raw response text:");
    console.log(text.slice(0, 500)); // Print first 500 chars for inspection

    const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);?$/);
    if (!match) {
      console.error("❌ Match failed. Feed data is not in expected format.");
      return;
    }

    const json = JSON.parse(match[1]);
    console.log("[loadFeed] Parsed JSON:", json);

    const rows = json.table.rows.map(row => {
      const c = row.c;
      return {
        to: c[0]?.v || "",
        type: c[1]?.v || "",
        scenarioNumber: c[2]?.v || "",
        scenarioName: c[3]?.v || "",
        category: c[4]?.v || "",
        difficulty: c[5]?.v || "",
        clearCondition: c[6]?.v || "",
        timeLimit: c[7]?.v || "",
        rewards: c[8]?.v || "",
        penalty: c[9]?.v || "",
        text: c[10]?.v || "",
        order: parseInt(c[11]?.v) || 0
      };
    });

    rows.sort((a,b) => b.order - a.order);

    const dataStr = JSON.stringify(rows);
    if (dataStr !== lastData) {
      lastData = dataStr;
      console.log(`[loadFeed] 🔄 Feed changed. Rendering ${rows.length} items.`);
      renderFeed(rows);
      showRefreshNotice();
    } else {
      console.log("[loadFeed] ✅ Feed unchanged.");
    }

  } catch(e) {
    console.error("❌ Error loading feed:", e);
  }
}

// --- Render feed ---
function renderFeed(posts){
  const feed = document.getElementById("feed");
  feed.innerHTML = "";
  let shown = 0;

  posts.forEach(p => {
    if(p.to === "all" || p.to === currentUser || currentUser === "Cole"){
      shown++;
      const container = document.createElement("div");
      container.style.position = "relative";
      container.style.margin = "20px auto";
      container.style.textAlign = "center";

      const img = document.createElement("img");
      img.style.width = "100%";
      img.style.display = "block";

      const overlay = document.createElement("div");
      overlay.className = "text-overlay";

      if(p.type === "message"){
        img.src = "images/message.png";
        overlay.innerText = p.text || "";
        overlay.style.fontSize = "22px";
        overlay.style.paddingTop = "180px";    
        overlay.style.paddingLeft = "80px";    
      } else if(p.type === "scenario"){
        img.src = "images/scenario.png";
        overlay.innerText = `< ${p.category} Scenario #${p.scenarioNumber} – ${p.scenarioName} >

CATEGORY: ${p.category}

DIFFICULT: ${p.difficulty}

CLEAR CONDITION: ${p.clearCondition}

TIME LIMIT: ${p.timeLimit}

REWARDS: ${p.rewards}

PENALTY FOR FAILURE: ${p.penalty}`;
        overlay.style.fontSize = "18px";
        overlay.style.paddingTop = "120px";   
        overlay.style.paddingLeft = "140px";  
      }

      container.appendChild(img);
      container.appendChild(overlay);
      feed.appendChild(container);
    }
  });

  logDebug(`🖼️ Rendered ${shown} of ${posts.length} posts`);
}

// --- Fade-in/out refresh notice ---
function showRefreshNotice(){
  const notice = document.getElementById("refreshNotice");
  notice.style.opacity = "1";
  setTimeout(() => { notice.style.opacity = "0"; }, 2000);
}

// --- Fade-in/out submit notice ---
function showSubmitNotice(){
  const notice = document.getElementById("submitNotice");
  notice.style.opacity = "1";
  setTimeout(() => { notice.style.opacity = "0"; }, 2000);
}
</script>
</body>
</html>
