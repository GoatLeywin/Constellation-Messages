<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Star Stream</title>

  <!-- Site icon (favicon) -->
  <link rel="icon" type="image/png" href="images/icon.png">

  <style>
    body { font-family: sans-serif; background:#111; color:#eee; margin:0; }
    #login { max-width:400px; margin:100px auto; text-align:center; }
    #feed { max-width:800px; margin:20px auto; display:none; padding:0 16px; position:relative; }
    input, select, textarea { padding:6px; margin:6px; border-radius:6px; border:none; }
    button { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; background:#444; color:#fff; }
    button:hover { background:#666; }
    img { max-width:100%; display:block; }
    .text-overlay {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      color: #fff;
      text-align: left;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: monospace;
      text-shadow: 2px 2px 4px #000;
      pointer-events: none;
      overflow-wrap: break-word;
      max-width: 70%;
      padding-right: 15%;
    }

    #refreshNotice, #submitNotice {
      position: fixed;
      top: 20px;
      right: 30px;
      font-family: monospace;
      font-size: 14px;
      color: #fff;
      text-shadow: 1px 1px 3px #000;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      pointer-events: none;
      z-index: 9999;
    }

    /* --- Cole control panel --- */
    #colePanel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.9);
      padding: 12px;
      border-radius: 8px;
      display: none;
      z-index: 20000;
    }
    #colePanel h3 { margin: 0 0 8px 0; font-size: 16px; }
    #colePanel label { display: block; margin-top: 6px; font-size: 13px; }
    #colePanel textarea { width: 200px; height: 60px; }
  </style>
</head>
<body>
  <div id="login">
    <h2>üîí Sign In</h2>
    <input id="user" placeholder="User ID" />
    <input id="pass" type="password" placeholder="Password" />
    <button onclick="login()">Enter</button>
    <p id="msg"></p>
  </div>

  <div id="feed"></div>
  <div id="refreshNotice">‚ü≥ feed refreshed</div>
  <div id="submitNotice">‚úî entry submitted</div>

  <!-- Cole control panel -->
  <div id="colePanel">
    <h3>üìù New Entry</h3>
    <label>Type:
      <select id="entryType" onchange="updateColeForm()">
        <option value="message">Message</option>
        <option value="scenario">Scenario</option>
      </select>
    </label>
    <div id="formFields"></div>
    <button onclick="submitColeEntry()">Submit</button>
  </div>

<script>
// --- USERS ---
const USERS = {
  "Scott": "madhatter",
  "Dexter": "funk",
  "Kade": "KRKR-110108",
  "Cole": "ILoveMarley"
};

let currentUser = null;
let lastData = "";

// --- Login ---
function login(){
  const u = document.getElementById("user").value.trim();
  const p = document.getElementById("pass").value;
  if(USERS[u] && USERS[u] === p){
    currentUser = u;
    document.getElementById("login").style.display = "none";
    document.getElementById("feed").style.display = "block";
    startAutoRefresh();

    if(currentUser === "Cole"){
      document.getElementById("colePanel").style.display = "block";
      logColeLogin();
      updateColeForm();
    }
  } else {
    document.getElementById("msg").innerText = "‚ùå Invalid login";
  }
}

// --- Send row to Google Sheets ---
async function logColeLogin(){
  const payload = {
    to: "Cole",
    type: "login",
    scenarioNumber: "",
    scenarioName: "",
    category: "System",
    difficulty: "",
    clearCondition: "",
    timeLimit: "",
    rewards: "",
    penalty: "",
    text: "Cole logged in at " + new Date().toLocaleString(),
    order: Date.now()
  };

  try {
    await fetch("https://script.google.com/macros/s/AKfycbxQxeSiIWpwP96VYiognZePsGBlIyEFDwdxVf3u0eS3ksukcaPCeuabPUpt_jI7XpD20g/exec", {
      method: "POST",
      body: JSON.stringify(payload),
      headers: { "Content-Type": "application/json" },
      mode: "no-cors"
    });
  } catch(err) {
    console.error("‚ùå Exception while logging Cole login: " + err);
  }
}

// --- Cole form builder ---
function updateColeForm(){
  const type = document.getElementById("entryType").value;
  const form = document.getElementById("formFields");
  form.innerHTML = "";

  if(type === "message"){
    form.innerHTML = `
      <label>To: <input id="msgTo" value="all"></label>
      <label>Text:<br><textarea id="msgText"></textarea></label>
    `;
  } else if(type === "scenario"){
    form.innerHTML = `
      <label>To: <input id="scenTo" value="all"></label>
      <label>Scenario # <input id="scenNum"></label>
      <label>Name <input id="scenName"></label>
      <label>Category <input id="scenCat"></label>
      <label>Difficulty <input id="scenDiff"></label>
      <label>Clear Condition <input id="scenCond"></label>
      <label>Time Limit <input id="scenTime"></label>
      <label>Rewards <input id="scenRew"></label>
      <label>Penalty <input id="scenPen"></label>
    `;
  }
}

// --- Cole entry submit ---
async function submitColeEntry(){
  const type = document.getElementById("entryType").value;
  let payload = {};

  if(type === "message"){
    payload = {
      to: document.getElementById("msgTo").value,
      type: "message",
      scenarioNumber: "",
      scenarioName: "",
      category: "",
      difficulty: "",
      clearCondition: "",
      timeLimit: "",
      rewards: "",
      penalty: "",
      text: document.getElementById("msgText").value,
      order: Date.now()
    };
  } else {
    payload = {
      to: document.getElementById("scenTo").value,
      type: "scenario",
      scenarioNumber: document.getElementById("scenNum").value,
      scenarioName: document.getElementById("scenName").value,
      category: document.getElementById("scenCat").value,
      difficulty: document.getElementById("scenDiff").value,
      clearCondition: document.getElementById("scenCond").value,
      timeLimit: document.getElementById("scenTime").value,
      rewards: document.getElementById("scenRew").value,
      penalty: document.getElementById("scenPen").value,
      text: "",
      order: Date.now()
    };
  }

  try {
    await fetch("https://script.google.com/macros/s/AKfycbxQxeSiIWpwP96VYiognZePsGBlIyEFDwdxVf3u0eS3ksukcaPCeuabPUpt_jI7XpD20g/exec", {
      method: "POST",
      body: JSON.stringify(payload),
      headers: { "Content-Type": "application/json" },
      mode: "no-cors"
    });
    showSubmitNotice();
  } catch(err){
    console.error("‚ùå Exception while submitting entry: " + err);
  }
}

// --- Auto-refresh feed ---
function startAutoRefresh(){
  loadFeed();
  setInterval(loadFeed, 15000);
}

// --- Fetch posts from Google Sheets (CSV) ---
async function loadFeed(){
  const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT4Grw3tRlqGbesjOvBSJ74P-dWTId_l34k4tXiuXEmJQUo-qi-f67C3tllucwzOzFLaPaP9CPe4i8D/pub?gid=0&single=true&output=csv";
  try {
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP error: ${res.status}`);
    const csvText = await res.text();
    const lines = csvText.trim().split("\n");
    lines.shift(); // remove header

    const posts = lines.map(line => {
      const values = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"' && line[i+1] === '"') { current += '"'; i++; }
        else if (char === '"') { inQuotes = !inQuotes; }
        else if (char === ',' && !inQuotes) { values.push(current); current = ''; }
        else { current += char; }
      }
      values.push(current);

      return {
        to: values[0]?.trim(),
        type: values[1]?.trim(),
        scenarioNumber: values[2]?.trim(),
        scenarioName: values[3]?.trim(),
        category: values[4]?.trim(),
        difficulty: values[5]?.trim(),
        clearCondition: values[6]?.trim(),
        timeLimit: values[7]?.trim(),
        rewards: values[8]?.trim(),
        penalty: values[9]?.trim(),
        text: values[10]?.trim(),
        order: parseInt(values[11]?.trim() || "0", 10)
      };
    });

    posts.sort((a,b) => b.order - a.order);

    const dataStr = JSON.stringify(posts);
    if (dataStr !== lastData) { 
      lastData = dataStr; 
      renderFeed(posts); 
      showRefreshNotice();
    }

  } catch(e) {
    console.error("‚ùå Error loading feed: " + e);
  }
}

// --- Render feed ---
function renderFeed(posts){
  const feed = document.getElementById("feed");
  feed.innerHTML = "";

  posts.forEach(p => {
    if(p.to === "all" || p.to === currentUser || currentUser === "Cole"){
      const container = document.createElement("div");
      container.style.position = "relative";
      container.style.margin = "20px auto";
      container.style.textAlign = "center";

      const img = document.createElement("img");
      img.style.width = "100%";
      img.style.display = "block";

      const overlay = document.createElement("div");
      overlay.className = "text-overlay";

      if(p.type === "message"){
        img.src = "images/message.png";
        overlay.innerText = p.text || "";
        overlay.style.fontSize = "22px";
        overlay.style.paddingTop = "180px";    
        overlay.style.paddingLeft = "80px";    
      } else if(p.type === "scenario"){
        img.src = "images/scenario.png";
        overlay.innerText = `< ${p.category} Scenario #${p.scenarioNumber} ‚Äì ${p.scenarioName} >

CATEGORY: ${p.category}

DIFFICULT: ${p.difficulty}

CLEAR CONDITION: ${p.clearCondition}

TIME LIMIT: ${p.timeLimit}

REWARDS: ${p.rewards}

PENALTY FOR FAILURE: ${p.penalty}`;
        overlay.style.fontSize = "18px";
        overlay.style.paddingTop = "120px";   
        overlay.style.paddingLeft = "140px";  
      }

      container.appendChild(img);
      container.appendChild(overlay);
      feed.appendChild(container);
    }
  });
}

// --- Fade-in/out refresh notice ---
function showRefreshNotice(){
  const notice = document.getElementById("refreshNotice");
  notice.style.opacity = "1";
  setTimeout(() => { notice.style.opacity = "0"; }, 2000);
}

// --- Fade-in/out submit notice ---
function showSubmitNotice(){
  const notice = document.getElementById("submitNotice");
  notice.style.opacity = "1";
  setTimeout(() => { notice.style.opacity = "0"; }, 2000);
}
</script>
</body>
</html>
